#!/usr/bin/env python
from jinja2 import Environment, FileSystemLoader
import os
from subprocess import call

def generate_broker_manifest():
    broker_manifest_file_name = 'broker-deploy-manifest.yml'
    broker_manifest_template_file = 'broker-deploy-manifest.template.yml'
    template_folder='ci/templates'
    broker_manifest_file_path = os.path.join(template_folder, broker_manifest_file_name)

    env = Environment(loader=FileSystemLoader(template_folder))
    template = env.get_template(broker_manifest_template_file)
    broker_plans=os.environ['BROKER_PLANS'].split(',')
    rendered = template.render(
        broker_password=os.environ['BROKER_PASSWORD'],
        broker_plans=broker_plans,
        broker_port=os.environ['BROKER_PORT'],
        broker_service_name=os.environ['BROKER_SERVICE_NAME'],
        broker_service_uuid=os.environ['BROKER_SERVICE_UUID'],
        broker_username=os.environ['BROKER_USERNAME'],
        cf_domain=os.environ['CF_DOMAIN'],
        cf_password=os.environ['CF_PASSWORD'],
        cf_username=os.environ['CF_USERNAME'],
        diego_driver_name=os.environ['DIEGO_DRIVER_NAME'],
        libstorage_uri=os.environ['LIBSTORAGE_URI'],
        static_ip=os.environ['STATIC_IP']
    )
    print(rendered)
    with open(broker_manifest_file_path, 'w') as f:
        f.write(rendered)

    return broker_manifest_file_path

def bosh_target(uri, username, password):
    call(["bosh", "-n", "target", uri])
    call(["bosh", "login", username, password])

def bosh_deploy(manifest_path):
    call(["bosh", "deployment", manifest_path])
    call(["bosh", "-n", "deploy"])
    call(["bosh", "-n", "run", "errand", "register-broker"])
    call(["bosh", "-n", "run", "errand", "deregister-broker"])

def bosh_delete_deployment(deployment_name):
    call(["bosh", "-n", "delete", "deployment", deployment_name])

def main():
    bosh_uri=os.environ['BOSH_URI']
    bosh_password=os.environ['BOSH_PASSWORD']
    bosh_username=os.environ['BOSH_USERNAME']

    os.chdir('emc-persistence-release')
    manifest_path = generate_broker_manifest()
    bosh_target(bosh_uri, bosh_username, bosh_password)
    bosh_deploy(manifest_path)
    bosh_delete_deployment("persistent-broker")

if __name__ == '__main__':
    main()
